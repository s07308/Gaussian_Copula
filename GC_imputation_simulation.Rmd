---
title: "GC_imputation"
author: "YI-CHENG, TAI"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(mvtnorm)
```

```{r}
rho <- 0.5
cut.off <- c(-1, 1)
size <- 500
Z <- rmvnorm(n = size, sigma = matrix(c(1, rho, rho, 1), nrow = 2))
T1 <- exp(Z[, 1])
X1 <- ifelse(Z[, 2] < cut.off[1], 0,
             ifelse(Z[, 2] < cut.off[2], 1, 2))
C <- rexp(n = size, rate = 0.5)
Y1 <- ifelse(T1 < C, T1, C)
delta <- ifelse(T1 < C, 1, 0)
```

```{r}
mean(delta)
```

```{r}
df.pair <- matrix(nrow = choose(n = size, k = 2), ncol = 8)

k <- 1
for(i in seq(1, size - 1)) {
  for(j in seq(i + 1, size)) {
    df.pair[k, ] <- c(X1[i], Y1[i], delta[i], T1[i], X1[j], Y1[j], delta[j], T1[j])
    k <- k + 1
  }
}
```

probability that $T_i > T_{i'}$
```{r}
mean(df.pair[, 4] > df.pair[, 8])
```

**Case 2** <br>
```{r}
df.2 <- df.pair[df.pair[, 2] > df.pair[, 6] & df.pair[, 3] > df.pair[, 7], ]
df.2[1, ]
```

```{r}
b.imputed.2 <- numeric(length = nrow(df.2))

for(i in seq(1, nrow(df.2))) {
  if(df.2[i, 5] == 0) {
    b.imputed.2[i] <- pmvnorm(lower = c(-Inf, log(df.2[i, 6])),
                              upper = c(cut.off[1], log(df.2[i, 2])),
                              mean = c(0, 0),
                              corr = matrix(c(1, rho, rho, 1), nrow = 2))
    
    b.imputed.2[i] <- b.imputed.2[i] / pmvnorm(lower = c(-Inf, log(df.2[i, 6])),
                                               upper = c(cut.off[1], Inf),
                                               mean = c(0, 0),
                                               corr = matrix(c(1, rho, rho, 1), nrow = 2))
  } else if(df.2[i, 5] == 1) {
    b.imputed.2[i] <- pmvnorm(lower = c(cut.off[1], log(df.2[i, 6])),
                              upper = c(cut.off[2], log(df.2[i, 2])),
                              mean = c(0, 0),
                              corr = matrix(c(1, rho, rho, 1), nrow = 2))
    
    b.imputed.2[i] <- b.imputed.2[i] / pmvnorm(lower = c(cut.off[1], log(df.2[i, 6])),
                                               upper = c(cut.off[2], Inf),
                                               mean = c(0, 0),
                                               corr = matrix(c(1, rho, rho, 1), nrow = 2))
  } else {
    b.imputed.2[i] <- pmvnorm(lower = c(cut.off[2], log(df.2[i, 6])),
                              upper = c(Inf, log(df.2[i, 2])),
                              mean = c(0, 0),
                              corr = matrix(c(1, rho, rho, 1), nrow = 2))
    
    b.imputed.2[i] <- b.imputed.2[i] / pmvnorm(lower = c(cut.off[2], log(df.2[i, 6])),
                                               upper = c(Inf, Inf),
                                               mean = c(0, 0),
                                               corr = matrix(c(1, rho, rho, 1), nrow = 2))
  }
}
```

```{r}
## data.frame(b.imputed.2, df.2[, 4] > df.2[, 8]) 
mean((b.imputed.2 > 0.5) == (df.2[, 4] > df.2[, 8]))
```

**Case 3** <br>
```{r}
df.3 <- df.pair[df.pair[, 2] > df.pair[, 6] & df.pair[, 3] == 0 & df.pair[, 7] == 0, ]
df.3[1, ]
```

```{r}
b.imputed.3 <- numeric(length = nrow(df.3))

for(i in seq(1, nrow(df.3))) {
  if(df.2[i, 5] == 0) {
    b.imputed.2[i] <- pmvnorm(lower = c(-Inf, log(df.2[i, 6])),
                              upper = c(cut.off[1], log(df.2[i, 2])),
                              mean = c(0, 0),
                              corr = matrix(c(1, rho, rho, 1), nrow = 2))
    
    b.imputed.2[i] <- b.imputed.2[i] / pmvnorm(lower = c(-Inf, log(df.2[i, 6])),
                                               upper = c(cut.off[1], Inf),
                                               mean = c(0, 0),
                                               corr = matrix(c(1, rho, rho, 1), nrow = 2))
  } else if(df.2[i, 5] == 1) {
    b.imputed.2[i] <- pmvnorm(lower = c(cut.off[1], log(df.2[i, 6])),
                              upper = c(cut.off[2], log(df.2[i, 2])),
                              mean = c(0, 0),
                              corr = matrix(c(1, rho, rho, 1), nrow = 2))
    
    b.imputed.2[i] <- b.imputed.2[i] / pmvnorm(lower = c(cut.off[1], log(df.2[i, 6])),
                                               upper = c(cut.off[2], Inf),
                                               mean = c(0, 0),
                                               corr = matrix(c(1, rho, rho, 1), nrow = 2))
  } else {
    b.imputed.2[i] <- pmvnorm(lower = c(cut.off[2], log(df.2[i, 6])),
                              upper = c(Inf, log(df.2[i, 2])),
                              mean = c(0, 0),
                              corr = matrix(c(1, rho, rho, 1), nrow = 2))
    
    b.imputed.2[i] <- b.imputed.2[i] / pmvnorm(lower = c(cut.off[2], log(df.2[i, 6])),
                                               upper = c(Inf, Inf),
                                               mean = c(0, 0),
                                               corr = matrix(c(1, rho, rho, 1), nrow = 2))
  }
}
```

```{r}
## data.frame(b.imputed.2, df.2[, 4] > df.2[, 8]) 
mean((b.imputed.2 > 0.5) == (df.2[, 4] > df.2[, 8]))
```